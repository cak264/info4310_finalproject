<html>
    <header>
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <style>
            .gridlines line {
              stroke: #bbb;
            }

            .gridlines .domain {
              stroke: none;
            }

            #vis1, #vis2, #vis3, #vis4 {
                display: flex;
                justify-content: center;
            }

            #vis1 #filters {
                margin-left: 30px;
            }

            #institutionInputs, #degreeInputs, #binInputs {
                display: flex;
                flex-direction: column;
            }

            #ivy-main, #ivy_filters, #ivy-bonus, #ivy_bonus_filters {
                float: left;
            }

            #ivy_filters, #ivy_bonus_filters {
                width: 230px;
                height: 400px;
                margin-left: 30px;
            }

            h2 {
                text-align: center;
                margin-top: 80px;
                margin-bottom: 50px;
            }

            h1, h3 {
                text-align: center;
                margin-bottom: 0px;
            }

            h1 {
                padding-top: 30px;
            }

            #context {
                width: 600px;
                text-align: center;
            }

            #vis4, #vis4_title {
                display: none;
            }

        </style>
    </header>
    <body>

        <h1>How Economically Accessible Are US Universities?</h1>
        <h3 id="head_h3">Cameron Kull, cak264 & Marie Williams, mcw242</h3>
        <div id="context">
            <p>To add: context for article</p>
        </div>

        <h2>Title</h2>
        <div id="vis1">
            <svg width="900" height="600" id="line-chart"></svg>
            <g id="filters"></g>
        </div>

        <h2>Title</h2>
        <div id="vis2">
            <svg width="600" height="400" id="line-chart-bonus"></svg>
        </div>

        <h2>A Look At The Percentage of Students Belonging To The X Across Top US Universities</h2>
        <div id="vis3">
            <svg width="900" height="600" id="ivy-main"></svg>
            <div id ="ivy_filters">
                <h2>Filters</h2>
            </div>
        </div>

        <h2 id="vis4_title">Parental Income Distribution At X</h2>
        <div id="vis4">
            <svg width="600" height="400" id="ivy-bonus"></svg>
            <div id ="ivy_bonus_filters">
                <h2>Filters</h2>
            </div>
        </div>


        <script>
            let lineChart = d3.select("#line-chart");
            const lc_width = lineChart.attr("width");
            const lc_height= lineChart.attr("height");
            const lc_margins={top: 10, right: 10, bottom: 50, left: 60};
            const lchartWidth = lc_width - lc_margins.left - lc_margins.right;
            const lchartHeight = lc_height - lc_margins.top - lc_margins.bottom;
            const lineChartArea = lineChart.append("g")
                                           .attr("transform", `translate(${lc_margins.left}, ${lc_margins.top})`);

            let lineBChart = d3.select("#line-chart-bonus");
            const lc_Bwidth = lineBChart.attr("width");
            const lc_Bheight= lineBChart.attr("height");
            const lc_Bmargins={top: 10, right: 10, bottom: 50, left: 60};
            const lBchartWidth = lc_Bwidth - lc_Bmargins.left - lc_Bmargins.right;
            const lBchartHeight = lc_Bheight - lc_Bmargins.top - lc_Bmargins.bottom;
            const lineBChartArea = lineBChart.append("g")
                                           .attr("transform", `translate(${lc_Bmargins.left}, ${lc_Bmargins.top})`);

            let ivyChart = d3.select("#ivy-main");
            const ivy_width = ivyChart.attr("width");
            const ivy_height= ivyChart.attr("height");
            const ivy_margins={top: 10, right: 10, bottom: 80, left: 50};
            const ivyChartWidth = ivy_width - ivy_margins.left - ivy_margins.right;
            const ivyChartHeight = ivy_height - ivy_margins.top - ivy_margins.bottom;
            const ivyChartArea = ivyChart.append("g")
                                           .attr("transform", `translate(${ivy_margins.left}, ${ivy_margins.top})`);

            // comment
            let ivyBChart = d3.select("#ivy-bonus");
            const ivy_Bwidth = ivyBChart.attr("width");
            const ivy_Bheight= ivyBChart.attr("height");
            const ivy_Bmargins={top: 10, right: 10, bottom: 50, left: 50};
            const ivyBChartWidth = ivy_Bwidth - ivy_Bmargins.left - ivy_Bmargins.right;
            const ivyBChartHeight = ivy_Bheight - ivy_Bmargins.top - ivy_Bmargins.bottom;
            const ivyBChartArea = ivyBChart.append("g")
                                           .attr("transform", `translate(${ivy_Bmargins.left}, ${ivy_Bmargins.top})`);



            let requestData = async function(){
                let meanIncomes = await d3.csv("mean_income.csv", d3.autoType);
                console.log(meanIncomes);

                let tuition = await d3.csv("tuition.csv", d3.autoType);
                console.log(tuition);

                let parentBins = await d3.csv("parent_incomes.csv", d3.autoType);
                console.log(parentBins);

                let attendStats = await d3.csv("top139_attend.csv", d3.autoType);
                console.log(attendStats);

                // income and year extents and scales
                let yearExtent = d3.extent(meanIncomes, m=>m.Year);

                let yearScale = d3.scaleLinear().domain(yearExtent).range([0, lchartWidth]);
                let lowIncomeExtent = d3.extent(meanIncomes, m=>m.current_firstQuintile);
                let highIncomeExtent = d3.extent(meanIncomes, m=>m.current_fifthQuintile);
                let middleIncomeExtent = d3.extent(meanIncomes, m=>m.current_thirdQuintile);
                // let dollarScale = d3.scaleLinear().domain([lowIncomeExtent[0], highIncomeExtent[1]]).range([lchartHeight, 0]);
                let dollarScale = d3.scaleLinear().domain([lowIncomeExtent[0], middleIncomeExtent[1]+5000]).range([lchartHeight, 0]);

                // axes
                let lineLeftAxis = d3.axisLeft(dollarScale);
                lineChart.append("g")
                             .attr("transform", `translate(${lc_margins.left-10}, ${lc_margins.top})`)
                             .call(lineLeftAxis);
                let lineLeftAxisGridlines = d3.axisLeft(dollarScale)
                                              .tickSize(-lchartWidth-10)
                                              .tickFormat('');
                lineChart.append("g")
                             .attr("transform", `translate(${lc_margins.left-10}, ${lc_margins.top})`)
                             .attr("class", "gridlines")
                             .call(lineLeftAxisGridlines);

                let lineBottomAxis = d3.axisBottom(yearScale)
                                       .tickFormat(d3.format(".0f"));
                lineChart.append("g")
                             .attr("transform", `translate(${lc_margins.left}, ${lc_margins.top+lchartHeight+10})`)
                             .call(lineBottomAxis);

                lineChartArea.raise();



                // creating tuition line
                function updateBars(dol_type) {

                    // create bars
                    lineChartArea.selectAll("rect.vis1Bar").data(meanIncomes)
                                .join("rect")
                                .transition().duration(500)
                                .attr("class", "vis1Bar")
                                .attr("x", m=> yearScale(m.Year)-4)
                                .attr("y", m=> dollarScale(m[dol_type+"_thirdQuintile"]))
                                .attr("width", 10)
                                .attr("height", m=> lchartHeight-dollarScale(m[dol_type+"_thirdQuintile"]))
                                .attr("fill", "steelblue");

                }

                function createLine(inst_type, dol_type, degree_length){

                    let filteredTuition = tuition.filter(t=> t.institution_type == inst_type & t.dollar_type == dol_type);

                    let line = d3.line()
                            .x(d => yearScale(d.year))
                            .y(d => dollarScale(d[degree_length]));

                    lineChartArea.append("path").datum(filteredTuition)
                                .join("path")
                                .attr("id", inst_type+"_"+dol_type)
                                .attr("class", "tuitionLine")
                                .attr("fill", "none")
                                .attr("stroke", "black")
                                .attr("stroke-width", 3)
                                .attr("d", line);
                };

                function deleteLine(inst_type, dol_type) {
                    var line = d3.select("path#"+inst_type+"_"+dol_type)
                    if (line) {
                        line.remove(); // Remove the path element from the DOM
                    } else {
                        console.log("Path element not found.");
                    }
                };

                function deleteAllLines(){
                    d3.selectAll("path.tuitionLine").remove();
                }

                let currentDollarType = "current";
                let currentDegreeLength = "four_and_two_year";
                updateBars(currentDollarType);
                createLine("all", currentDollarType, currentDegreeLength);


                // adding inputs to filter panel
                let filterPanel = d3.select("#filters");
                filterPanel.append("h2").text("University Details");

                filterPanel.append("h3").text("Dollar Value");
                filterPanel.append("button").text("Current Dollars").attr("id", "currentButton");
                filterPanel.append("button").text("2021 Adjusted Dollars").attr("id", "adjustedButton");

                filterPanel.append("h3").text("Institution Type");
                let institutionInputs = filterPanel.append("div").attr("id", "institutionInputs");
                let inst_types = ["All", "Public", "Private", "Nonprofit", "For-Profit"];
                inst_types.forEach(type => {
                    let block = institutionInputs.append("g");
                    block.append("input").attr("type", "checkbox").attr("id", "check1"+type);
                    block.append("label").attr("for", "check1"+type).text(type);
                });
                d3.select("#check1All").property("checked", true);

                filterPanel.append("h3").text("Degree Length");
                let degreeInputs = filterPanel.append("div").attr("id", "degreeInputs");
                let degree_types = ["All", "Four", "Two"];
                degree_types.forEach(type => {
                    let block = degreeInputs.append("g");
                    block.append("input").attr("type", "checkbox").attr("id", "check2"+type);
                    block.append("label").attr("for", "check2"+type).text(type+" Year");
                })
                d3.select("#check2All").property("checked", true);

                // button interactivity
                d3.select("#currentButton").on("click", function(){
                    currentDollarType = "current";
                    deleteAllLines();
                    updateBars(currentDollarType);
                    addSelectedLines();
                })

                d3.select("#adjustedButton").on("click", function(){
                    currentDollarType = "adjusted";
                    deleteAllLines();
                    updateBars(currentDollarType);
                    addSelectedLines();
                })

                // checkbox interactivity

                function addSelectedLines(){
                    let selectedInputs = d3.selectAll("input[type=checkbox]:checked");
                    selectedInputs = selectedInputs.nodes();
                    selectedInputs.forEach(input =>{
                        let inputSection = input.id[5];
                        let type = input.id.substring(6).toLowerCase();
                        if (inputSection == 1){
                            if (type=="nonprofit" || type=="for-profit"){
                                createLine("private-"+type, currentDollarType, currentDegreeLength);
                            }
                            else{createLine(type, currentDollarType, currentDegreeLength);}
                        };
                    })
                }

                d3.selectAll("input").on("click", function(){
                    let inputSection = this.id[5];
                    let type = this.id.substring(6).toLowerCase();
                    if (inputSection == 1){
                        if (this.checked){
                            if (type=="nonprofit" || type=="for-profit"){
                                createLine("private-"+type, currentDollarType, currentDegreeLength);
                            }
                            else{createLine(type, currentDollarType, currentDegreeLength);}
                        }
                        else {
                            if (type=="nonprofit" || type=="for-profit"){
                                deleteLine("private-"+type, currentDollarType);
                            }
                            else{deleteLine(type, currentDollarType);}
                        }
                    }
                    else{
                        if (!this.checked){
                            d3.select(this).property("checked", true);
                            return;
                        };
                        if (type == "all"){
                            currentDegreeLength="four_and_two_year";
                            d3.select("#check2Four").property("checked", false);
                            d3.select("#check2Two").property("checked", false);
                            deleteAllLines(type, currentDollarType);
                            addSelectedLines();
                        }
                        else if (type == "four"){
                            let length = type+"_year"
                            currentDegreeLength=length;
                            d3.select("#check2All").property("checked", false);
                            d3.select("#check2Two").property("checked", false);
                            deleteAllLines();
                            addSelectedLines();
                        }
                        else{
                            let length = type+"_year"
                            currentDegreeLength=length;
                            d3.select("#check2All").property("checked", false);
                            d3.select("#check2Four").property("checked", false);
                            deleteAllLines();
                            addSelectedLines();
                        }
                    }
                })

                // line chart hover
                let barLabel = lineChartArea.append("text");
                let backgroundBox = lineChartArea.append("rect")
                                                 .attr("width", 100)
                                                 .attr("height", 25)
                                                 .attr("fill", "white")
                                                 .attr("visibility", "hidden");

                lineChartArea.selectAll("rect").on("mouseover", function(event, d){
                    d3.select(this)
                      .attr("stroke", "black")
                      .attr("stroke-width", 2);
                    if (d.Year<1974){
                        barLabel.text(d.Year+": $"+d[currentDollarType+"_thirdQuintile"])
                            .attr("x", yearScale(1974)-110)
                            .attr("y", dollarScale(d[currentDollarType+"_thirdQuintile"]))
                            .raise();
                        backgroundBox.attr("x", yearScale(1974)-110)
                                     .attr("y", dollarScale(d[currentDollarType+"_thirdQuintile"])-20)
                                     .attr("visibility", "visible");
                    }
                    else{
                        barLabel.text(d.Year+": $"+d[currentDollarType+"_thirdQuintile"])
                            .attr("x", yearScale(d.Year)-100)
                            .attr("y", dollarScale(d[currentDollarType+"_thirdQuintile"]))
                            .raise();
                        backgroundBox.attr("x", yearScale(d.Year)-100)
                                     .attr("y", dollarScale(d[currentDollarType+"_thirdQuintile"])-20)
                                     .attr("visibility", "visible");
                    }

                });

                lineChartArea.selectAll("rect").on("mouseout", function(){
                    d3.select(this)
                      .attr("stroke", "none");
                    barLabel.text("");
                    backgroundBox.attr("visibility", "hidden");
                });

                // Line Chart Bonus

                let line_qScale = d3.scaleBand().domain(['Q1', 'Q2', 'Q3', 'Q4', 'Q5']).range([0, lBchartWidth]).padding(0.1);

                let dollarBScale = d3.scaleLinear().domain([0, highIncomeExtent[1]]).range([lBchartHeight, 0]);

                let lineBLeftAxis = d3.axisLeft(dollarBScale);
                lineBChart.append("g")
                            .attr("class", "left-axis")
                            .attr("transform", `translate(${lc_Bmargins.left-10}, ${lc_Bmargins.top})`)
                            .call(lineBLeftAxis);
                let lineBLeftAxisGridlines = d3.axisLeft(dollarBScale)
                                            .tickSize(-lBchartWidth-10)
                                            .tickFormat('');
                lineBChart.append("g")
                            .attr("transform", `translate(${lc_Bmargins.left-10}, ${lc_Bmargins.top})`)
                            .attr("class", "gridlines")
                            .call(lineBLeftAxisGridlines);

                let lineBBottomAxis = d3.axisBottom(line_qScale);
                lineBChart.append("g")
                            .attr("class", "bottom-axis")
                            .attr("transform", `translate(${lc_Bmargins.left}, ${lc_Bmargins.top+lBchartHeight+10})`)
                            .call(lineBBottomAxis);


                // Ivy filters
                let IvyFilters = d3.select("#ivy_filters");
                let binInputs = IvyFilters.append("div").attr("id", "binInputs");

                let income_bins = {
                    "par_toppt1pc": "Top 0.1%",
                    "par_top1pc": "Top 1%",
                    "par_top5pc": "Top 5%",
                    "par_top10pc": "Top 10%",
                    "par_q5": "Top 20%",
                    "par_q4": "20-40th Percentile",
                    "par_q3": "40-60th Percentile",
                    "par_q2": "60-80th Percentile",
                    "par_q1": "Lowest 20%",

                };

                Object.entries(income_bins).forEach(([key, value]) => {
                    let block = binInputs.append("g");
                    let input = block.append("input")
                         .attr("type", "radio")
                         .attr("id", "check1" + key)
                         .attr("class", "income_radio")
                         .attr("value", key);
                    if (key === "par_q1") {
                        input.attr("checked", true);
                    }
                    block.append("label")
                         .attr("for", "check1" + key)
                         .text(value);
                });


                // ivy chart
                let colorScale = d3.scaleOrdinal()
                    .domain(parentBins.map(s=>s.name))
                    .range(["#4E3629", "#9BCBEB", "#B31B1B", "#046A38", "#003087", "#A41034", "#750014", "#FF671F", "#8C1515", "#800000", "#011F5B", "#00356B", "gray"]);

                let iconUrlMap = {
                    "Brown": "brown.png",
                    "Columbia": "columbia.svg",
                    "Cornell": "cornell.png",
                    "Dartmouth": "dartmouth.png",
                    "Duke": "duke.png",
                    "Harvard": "harvard.png",
                    "MIT": "mit.png",
                    "Princeton": "princeton.png",
                    "Stanford": "stanford.png",
                    "Uchicago": "uchicago.png",
                    "Penn": "penn.png",
                    "Yale": "yale.png"
                };


                function updateChart(selectedOption) {
                    let schools = parentBins.map(s=>s.name);
                    console.log(schools);
                    let schoolScale = d3.scaleBand().domain(schools).range([0, ivyChartWidth]).padding(0.1);

                    let extent = d3.extent(parentBins, p => p[selectedOption]);
                    let percentScale = d3.scaleLinear().domain([0, extent[1]]).range([ivyChartHeight, 0]);

                    ivyChart.selectAll(".left-axis, .gridlines, .bottom-axis").remove();

                    let ivyLeftAxis = d3.axisLeft(percentScale);
                    ivyChart.append("g")
                                .attr("class", "left-axis")
                                .attr("transform", `translate(${ivy_margins.left-10}, ${ivy_margins.top})`)
                                .call(ivyLeftAxis);
                    let ivyLeftAxisGridlines = d3.axisLeft(percentScale)
                                                .tickSize(-ivyChartWidth-10)
                                                .tickFormat('');
                    ivyChart.append("g")
                                .attr("transform", `translate(${ivy_margins.left-10}, ${ivy_margins.top})`)
                                .attr("class", "gridlines")
                                .call(ivyLeftAxisGridlines);

                    // text or icons?
                    let ivyBottomAxis = d3.axisBottom(schoolScale)
                                            .tickFormat(d => {
                                                            if (d === "National Avg") {
                                                                return d;
                                                            } else {
                                                                return "";
                                                            }
                                                        });

                    let bottomAxisGroup = ivyChart.append("g")
                                .attr("class", "bottom-axis")
                                .attr("transform", `translate(${ivy_margins.left}, ${ivy_margins.top+ivyChartHeight+10})`);

                    Object.keys(iconUrlMap).forEach((school, index) => {
                        if (school !== "National Avg") {
                            let iconWidth = 20;
                            let iconHeight = 20;
                            let y_pos = 10;
                            let x_pos = index * 64 + 26;

                            if (school === "Yale") {
                                iconWidth = 32;
                                iconHeight = 32;
                                y_pos = 3;
                                x_pos = x_pos-5;

                            }

                            if (school === "Stanford") {
                                iconWidth = 26;
                                iconHeight = 26;
                                y_pos = 6;
                                x_pos = x_pos-3;
                            }


                            bottomAxisGroup.append("image")
                                .attr("xlink:href", iconUrlMap[school])
                                .attr("width", iconWidth)
                                .attr("height", iconHeight)
                                .attr("x", x_pos)
                                .attr("y", y_pos);
                        }
                    });

                    bottomAxisGroup.call(ivyBottomAxis);

                    ivyChartArea.raise();

                    ivyChartArea.selectAll("rect").data(parentBins)
                                .join("rect")
                                .transition().duration(500)
                                .attr("x", s => schoolScale(s.name) + 10)
                                .attr("y", p => percentScale(p[selectedOption]))
                                .attr("width", 35)
                                .attr("height", p => ivyChartHeight - percentScale(p[selectedOption]))
                                .attr("fill", s => colorScale(s.name));
                }

                updateChart("par_q1");

                d3.selectAll('input[type=radio][class=income_radio]').on('click', function() {

                    d3.selectAll('input[type=radio][class=income_radio]')
                        .filter(function() { return this !== event.target; })
                        .property('checked', false);

                    updateChart(this.value);
                });


                ivyChartArea.selectAll("rect")
                    .on("click", function(event, d) {

                        d3.select("#vis4")
                            .style("display", "flex");
                        d3.select("#vis4_title")
                            .style("display", "block");
                        // d3.select("#ivy_bonus_filters")
                        //     .style("float", "left");


                        // ivy bonus chart
                        let qScale = d3.scaleBand().domain(['Q1', 'Q2', 'Q3', 'Q4', 'Q5']).range([0, ivyBChartWidth]).padding(0.1);
                        let maxPct = d3.max(parentBins, d => d3.max([d.par_q1, d.par_q2, d.par_q3, d.par_q4, d.par_q5]));

                        let percentBScale = d3.scaleLinear().domain([0, maxPct]).range([ivyBChartHeight, 0]);

                        // ivyChart.selectAll(".left-axis, .gridlines, .bottom-axis").remove();

                        let ivyBLeftAxis = d3.axisLeft(percentBScale);
                        ivyBChart.append("g")
                                    .attr("class", "left-axis")
                                    .attr("transform", `translate(${ivy_Bmargins.left-10}, ${ivy_Bmargins.top})`)
                                    .call(ivyBLeftAxis);
                        let ivyBLeftAxisGridlines = d3.axisLeft(percentBScale)
                                                    .tickSize(-ivyBChartWidth-10)
                                                    .tickFormat('');
                        ivyBChart.append("g")
                                    .attr("transform", `translate(${ivy_Bmargins.left-10}, ${ivy_Bmargins.top})`)
                                    .attr("class", "gridlines")
                                    .call(ivyBLeftAxisGridlines);

                        let ivyBBottomAxis = d3.axisBottom(qScale);
                        ivyBChart.append("g")
                                    .attr("class", "bottom-axis")
                                    .attr("transform", `translate(${ivy_Bmargins.left}, ${ivy_Bmargins.top+ivyBChartHeight+10})`)
                                    .call(ivyBBottomAxis);


                        let clickedSchool = d.name;

                        let filteredData = parentBins.filter(item => item.name === clickedSchool);

                        ivyBChartArea.selectAll("rect")
                            .data(filteredData.flatMap(d =>
                                ["par_q1", "par_q2", "par_q3", "par_q4", "par_q5"].map((key, index) => ({
                                    school: d.name,
                                    value: d[key],
                                    key: "Q" + (index + 1)
                                }))
                            ))
                            .join("rect")
                            .transition().duration(500)
                            .attr("x", d => qScale(d.key) + 30)
                            .attr("y", d => percentBScale(d.value))
                            .attr("width", 35)
                            .attr("height", d => ivyBChartHeight - percentBScale(d.value))
                            .attr("fill", d => colorScale(d.school));

                        ivyBChartArea.raise();
                    });



            }

            requestData();
        </script>
    </body>
</html>
