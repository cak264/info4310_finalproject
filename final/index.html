<html>
    <header>
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <style>
            .gridlines line {
              stroke: #bbb;
            }

            .gridlines .domain {
              stroke: none;
            }

            #vis1, #vis2, #vis3 {
                display: flex;
                justify-content: center;
            }

            #vis4_title {
                margin-top: 0px;
                width: auto;
            }

            #vis4 {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            #vis4, #vis4_title, #explanation {
                display: none;
            }

            #vis1 #filters {
                margin-left: 30px;
            }

            #institutionInputs, #degreeInputs, #binInputs {
                display: flex;
                flex-direction: column;
            }

            #ivy-main, #ivy_filters, #ivy-bonus, #ivy_bonus_filters {
                float: left;
            }

            #ivy_filters, #ivy_bonus_filters {
                width: 200px;
                height: 400px;
                margin-left: 30px;
            }

            h2.title {
                text-align: center;
                margin-top: 80px;
                margin-bottom: 50px;
            }

            h1.title, h3.title {
                text-align: center;
                margin-bottom: 0px;
            }

            h1 {
                padding-top: 30px;
            }

            #context {
                width: 600px;
                text-align: center;
            }


            .ivy_rect:hover {
                cursor: pointer;
            }

            .buttonContainer {
                display: flex;
                flex-direction: column;
            }

            #vis1Container {
                width: 1450px;
                position: relative;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin-bottom: 100px;
                padding-top: 50px;
                padding-bottom: 20px;
            }

            #bonus-charts {
                position: relative;
                left: 10px;
                width: 420px;
            }

            .vis4 {
                width: 400px;
                padding-left: 40px;
                padding-top: 0px;
                margin-top: 0px;
            }



        </style>
    </header>
    <body>

        <h1 class="title">How Economically Accessible Are US Universities?</h1>
        <h3 id="head_h3" class="title">Cameron Kull, cak264 & Marie Williams, mcw242</h3>
        <div id="context">
            <p>To add: context for article</p>
        </div>

        <div id="vis1Container" style="border: 1px solid black">
            <div id="vis1">
                <g id="filters"></g>
                <svg width="800" height="600" id="line-chart"></svg>
                <div id="bonus-charts">
                    <svg width="400" height="350" id="line-chart-bonus"></svg>
                    <svg width="400" height="250" id="ratio-chart"></svg>
                </div>
            </div>
        </div>

        <div id="vis2">

        </div>

        <h2 id="vis3_title" class="title"></h2>
        <div id="vis3">
            <div id ="ivy_filters">
                <h3>Instructions</h3>
                <p><b>Hover</b> over a bar to see that school's exact percentage of parents belonging to the income group selected,
                     and <b>click</b> to see a breakdown of the parent income distribution for the selected school.</p>
                <p><i>Note: "National Avg" refers to the average percentage of students at a university belonging to the selected
                    income group across all US universities.</i></p>
                <h3>Filters</h3>
            </div>
            <svg width="800" height="600" id="ivy-main"></svg>

            <div id="vis4">
                <h3 id="vis4_title" class="title"></h2>
                <svg width="400" height="300" id="ivy-bonus"></svg>
                <p class="vis4"><i>Note: Q1 corresponds to the lowest income quintile, and Q5 corresponds to the highest.</i></p>
                <p class="vis4" id="q_popup"></p>
                <p class="vis4" id="explanation"><i>All ranks are relative to peer institutions, with rank 1
                being the school that has accepted the highest proportion of students from the relevant income group.</i><p>
            </div>
        </div>


        <script>
            let lineChart = d3.select("#line-chart");
            const lc_width = lineChart.attr("width");
            const lc_height= lineChart.attr("height");
            const lc_margins={top: 10, right: 10, bottom: 50, left: 60};
            const lchartWidth = lc_width - lc_margins.left - lc_margins.right;
            const lchartHeight = lc_height - lc_margins.top - lc_margins.bottom;
            const lineChartArea = lineChart.append("g")
                                           .attr("transform", `translate(${lc_margins.left}, ${lc_margins.top})`);

            let lineBChart = d3.select("#line-chart-bonus");
            const lc_Bwidth = lineBChart.attr("width");
            const lc_Bheight= lineBChart.attr("height");
            const lc_Bmargins={top: 20, right: 10, bottom: 50, left: 60};
            const lBchartWidth = lc_Bwidth - lc_Bmargins.left - lc_Bmargins.right;
            const lBchartHeight = lc_Bheight - lc_Bmargins.top - lc_Bmargins.bottom;
            const lineBChartArea = lineBChart.append("g")
                                           .attr("transform", `translate(${lc_Bmargins.left}, ${lc_Bmargins.top})`);
            lineBChart.attr("visibility", "hidden");

            let ratioChart = d3.select("#ratio-chart");
            const ratio_width = ratioChart.attr("width");
            const ratio_height= ratioChart.attr("height");
            const ratio_margins={top: 20, right: 10, bottom: 50, left: 60};
            const ratiochartWidth = ratio_width - ratio_margins.left - ratio_margins.right;
            const ratiochartHeight = ratio_height - ratio_margins.top - ratio_margins.bottom;
            const ratioChartArea = ratioChart.append("g")
                                           .attr("transform", `translate(${ratio_margins.left}, ${ratio_margins.top})`);

            let ivyChart = d3.select("#ivy-main");
            const ivy_width = ivyChart.attr("width");
            const ivy_height= ivyChart.attr("height");
            const ivy_margins={top: 10, right: 10, bottom: 80, left: 50};
            const ivyChartWidth = ivy_width - ivy_margins.left - ivy_margins.right;
            const ivyChartHeight = ivy_height - ivy_margins.top - ivy_margins.bottom;
            const ivyChartArea = ivyChart.append("g")
                                           .attr("transform", `translate(${ivy_margins.left}, ${ivy_margins.top})`);

            // comment
            let ivyBChart = d3.select("#ivy-bonus");
            const ivy_Bwidth = ivyBChart.attr("width");
            const ivy_Bheight= ivyBChart.attr("height");
            const ivy_Bmargins={top: 10, right: 10, bottom: 50, left: 50};
            const ivyBChartWidth = ivy_Bwidth - ivy_Bmargins.left - ivy_Bmargins.right;
            const ivyBChartHeight = ivy_Bheight - ivy_Bmargins.top - ivy_Bmargins.bottom;
            const ivyBChartArea = ivyBChart.append("g")
                                           .attr("transform", `translate(${ivy_Bmargins.left}, ${ivy_Bmargins.top})`);



            let requestData = async function(){
                let meanIncomes = await d3.csv("mean_income.csv", d3.autoType);
                console.log(meanIncomes);

                let tuition = await d3.csv("tuition.csv", d3.autoType);
                console.log(tuition);

                let parentBins = await d3.csv("parent_incomes.csv", d3.autoType);
                console.log(parentBins);

                let attendStats = await d3.csv("top139_attend.csv", d3.autoType);
                console.log(attendStats);

                // income and year extents and scales
                let yearExtent = d3.extent(meanIncomes, m=>m.Year);

                let yearScale = d3.scaleLinear().domain([yearExtent[0]-0.5, yearExtent[1]+0.5]).range([0, lchartWidth]);
                let highIncomeExtent = d3.extent(meanIncomes, m=>m.adjusted_fifthQuintile);
                let middleIncomeExtent = d3.extent(meanIncomes, m=>m.adjusted_thirdQuintile);
                let dollarScale = d3.scaleLinear().domain([0, middleIncomeExtent[1]+5000]).range([lchartHeight, 0]);
                //input institution type, output a color
                let lineColorScale = d3.scaleOrdinal().range(["#1b9e77", "#d95f02", "#7570b3", "#e7298a", "#e6ab02"]);

                // title
                let lineTitle = lineChart.append("text")
                                                   .attr("x", 70)
                                                   .attr("y", 15)
                                                   .style("font-size", 23)
                                                   .style("font-weight", "bold")
                                                   .text("Mean Income of Middle Class Americans and College Tuition Over Time");
                // axes
                let lineLeftAxis = d3.axisLeft(dollarScale);
                lineChart.append("g")
                             .attr("transform", `translate(${lc_margins.left-10}, ${lc_margins.top})`)
                             .call(lineLeftAxis);
                let lineLeftAxisGridlines = d3.axisLeft(dollarScale)
                                              .tickSize(-lchartWidth-10)
                                              .tickFormat('');
                lineChart.append("g")
                             .attr("transform", `translate(${lc_margins.left-10}, ${lc_margins.top})`)
                             .attr("class", "gridlines")
                             .call(lineLeftAxisGridlines);

                let lineBottomAxis = d3.axisBottom(yearScale)
                                       .tickFormat(d3.format(".0f"));
                lineChart.append("g")
                             .attr("transform", `translate(${lc_margins.left}, ${lc_margins.top+lchartHeight+10})`)
                             .call(lineBottomAxis);

                lineChartArea.raise();


                let barsCreated = false;
                // creating tuition line
                function updateBars(dol_type) {

                    // create bars
                    if (!barsCreated){
                        lineChartArea.selectAll("rect.vis1Bar").data(meanIncomes)
                                .join("rect")
                                .attr("class", "vis1Bar")
                                .attr("x", m=> yearScale(m.Year)-4)
                                .attr("y", m=> dollarScale(m[dol_type+"_thirdQuintile"]))
                                .attr("width", 12)
                                .attr("height", m=> lchartHeight-dollarScale(m[dol_type+"_thirdQuintile"]))
                                .attr("fill", "#e0e0e0");
                        barsCreated = true;
                    }
                    else {
                        lineChartArea.selectAll("rect.vis1Bar")
                                .transition().duration(500)
                                .attr("x", m=> yearScale(m.Year)-4)
                                .attr("y", m=> dollarScale(m[dol_type+"_thirdQuintile"]))
                                .attr("height", m=> lchartHeight-dollarScale(m[dol_type+"_thirdQuintile"]));
                    }
                    
                }

                function createLine(inst_type, dol_type, degree_length){

                    let filteredTuition = tuition.filter(t=> t.institution_type == inst_type & t.dollar_type == dol_type);

                    let line = d3.line()
                            .x(d => yearScale(d.year))
                            .y(d => dollarScale(d[degree_length]));

                    lineChartArea.append("path").datum(filteredTuition)
                                .join("path")
                                .attr("id", inst_type+"_"+dol_type)
                                .attr("class", "tuitionLine")
                                .attr("fill", "none")
                                .attr("stroke", lineColorScale(inst_type))
                                .attr("stroke-width", 3)
                                .attr("d", line);
                };

                function deleteLine(inst_type, dol_type) {
                    var line = d3.select("path#"+inst_type+"_"+dol_type)
                    if (line) {
                        line.remove(); // Remove the path element from the DOM
                    } else {
                        console.log("Path element not found.");
                    }
                };

                function deleteAllLines(){
                    d3.selectAll("path.tuitionLine").remove();
                }

                let currentDollarType = "current";
                let currentDegreeLength = "four_and_two_year";
                let currentSelectedYear = "";
                updateBars(currentDollarType);
                createLine("all", currentDollarType, currentDegreeLength);


                // adding inputs to filter panel
                let filterPanel = d3.select("#filters");
                filterPanel.append("h2").text("University Details");

                filterPanel.append("h3").text("Dollar Value");
                let buttonContainer = filterPanel.append("g").attr("class", "buttonContainer");
                buttonContainer.append("button").text("Current Dollars").attr("id", "currentButton");
                buttonContainer.append("button").text("2021 Adjusted Dollars").attr("id", "adjustedButton");

                filterPanel.append("h3").text("Institution Type");
                let institutionInputs = filterPanel.append("div").attr("id", "institutionInputs");
                let inst_types = ["All", "Public", "Private", "Nonprofit", "For-Profit"];
                inst_types.forEach(type => {
                    if (type == "Nonprofit" || type == "For-Profit"){
                        let block = institutionInputs.append("g");
                        block.append("input").attr("type", "checkbox").attr("id", "check1"+type).style("margin-left", 20);
                        block.append("label").attr("for", "check1"+type)
                                            .text(type)
                                            .style("color", lineColorScale(type.toLowerCase()))
                                            .style("font-weight", "bold");
                    }
                    else{
                        let block = institutionInputs.append("g");
                        block.append("input").attr("type", "checkbox").attr("id", "check1"+type);
                        block.append("label").attr("for", "check1"+type)
                                            .text(type)
                                            .style("color", lineColorScale(type.toLowerCase()))
                                            .style("font-weight", "bold");
                    }
                    
                });
                d3.select("#check1All").property("checked", true);

                filterPanel.append("h3").text("Degree Length");
                let degreeInputs = filterPanel.append("div").attr("id", "degreeInputs");
                let degree_types = ["All", "Four", "Two"];
                degree_types.forEach(type => {
                    let block = degreeInputs.append("g");
                    block.append("input").attr("type", "radio").attr("id", "check2"+type);
                    block.append("label").attr("for", "check2"+type).text(type+" Year");
                })
                d3.select("#check2All").property("checked", true);

                // button interactivity
                d3.select("#currentButton").on("click", function(){
                    currentDollarType = "current";
                    deleteAllLines();
                    updateBars(currentDollarType);
                    addSelectedLines();
                    updateDash(undefined, currentSelectedYear);
                    updateRatio();
                })

                d3.select("#adjustedButton").on("click", function(){
                    currentDollarType = "adjusted";
                    deleteAllLines();
                    updateBars(currentDollarType);
                    addSelectedLines();
                    updateDash(undefined, currentSelectedYear);
                    updateRatio();
                })

                // checkbox interactivity

                function addSelectedLines(){
                    let selectedInputs = d3.selectAll("input[type=checkbox]:checked");
                    selectedInputs = selectedInputs.nodes();
                    selectedInputs.forEach(input =>{
                        let inputSection = input.id[5];
                        let type = input.id.substring(6).toLowerCase();
                        if (inputSection == 1){
                            if (type=="nonprofit" || type=="for-profit"){
                                createLine(type, currentDollarType, currentDegreeLength);
                            }
                            else{createLine(type, currentDollarType, currentDegreeLength);}
                        };
                    })
                }

                d3.selectAll("input").on("click", function(){
                    let inputSection = this.id[5];
                    let type = this.id.substring(6).toLowerCase();
                    if (inputSection == 1){
                        if (this.checked){
                            if (type=="nonprofit" || type=="for-profit"){
                                createLine("private-"+type, currentDollarType, currentDegreeLength);
                            }
                            else{createLine(type, currentDollarType, currentDegreeLength);}
                        }
                        else {
                            if (type=="nonprofit" || type=="for-profit"){
                                deleteLine("private-"+type, currentDollarType);
                            }
                            else{deleteLine(type, currentDollarType);}
                        }
                    }
                    else{
                        if (type == "all"){
                            currentDegreeLength="four_and_two_year";
                            d3.select("#check2Four").property("checked", false);
                            d3.select("#check2Two").property("checked", false);
                            deleteAllLines(type, currentDollarType);
                            addSelectedLines();
                            updateRatio();
                        }
                        else if (type == "four"){
                            let length = type+"_year"
                            currentDegreeLength=length;
                            d3.select("#check2All").property("checked", false);
                            d3.select("#check2Two").property("checked", false);
                            deleteAllLines();
                            addSelectedLines();
                            updateRatio();
                        }
                        else{
                            let length = type+"_year"
                            currentDegreeLength=length;
                            d3.select("#check2All").property("checked", false);
                            d3.select("#check2Four").property("checked", false);
                            deleteAllLines();
                            addSelectedLines();
                            updateRatio();
                        }
                    }
                })

                // line chart hover
                let barLabel = lineChartArea.append("text")
                                            .attr("x", 10)
                                            .attr("y", 50)
                                            .attr("font-size", 20);

                lineChartArea.selectAll("rect").on("mouseover", function(event, d){
                    d3.select(this)
                      .attr("stroke", "#bab8b8")
                      .attr("stroke-width", 2);
                    barLabel.text(d.Year+": $"+d[currentDollarType+"_thirdQuintile"])
                            .raise();
                });

                lineChartArea.selectAll("rect").on("mouseout", function(){
                    d3.select(this)
                      .attr("stroke", "none");
                    barLabel.text("");
                });

                // Line Chart Bonus

                let line_qScale = d3.scaleBand().domain(['Q1', 'Q2', 'Q3', 'Q4', 'Q5']).range([0, lBchartWidth]).padding(0.01);
                let dollarBScale = d3.scaleLinear().domain([0, highIncomeExtent[1]+3000]).range([lBchartHeight, 0]);


                lineBChart.selectAll(".left-axis, .gridlines").remove();

                let lineBLeftAxis = d3.axisLeft(dollarBScale);
                lineBChart.append("g")
                            .attr("class", "left-axis")
                            .attr("transform", `translate(${lc_Bmargins.left-10}, ${lc_Bmargins.top})`)
                            .call(lineBLeftAxis);
                let lineBLeftAxisGridlines = d3.axisLeft(dollarBScale)
                                            .tickSize(-lBchartWidth-10)
                                            .tickFormat('');
                lineBChart.append("g")
                        .attr("transform", `translate(${lc_Bmargins.left-10}, ${lc_Bmargins.top})`)
                        .attr("class", "gridlines")
                        .call(lineBLeftAxisGridlines);

                let lineBBottomAxis = d3.axisBottom(line_qScale);
                lineBChart.append("g")
                            .attr("class", "bottom-axis")
                            .attr("transform", `translate(${lc_Bmargins.left}, ${lc_Bmargins.top+lBchartHeight+10})`)
                            .call(lineBBottomAxis);

                let hasBeenClicked = false;
                let tuitionLine = false;
                lineBChartArea.raise();
                let lineBonusTitle = lineBChart.append("text")
                                                   .attr("x", 100)
                                                   .attr("y", 15)
                                                   .style("font-size", 20)
                                                   .style("font-weight", "bold");
                let percentLabel = lineBChartArea.append("text");

                lineChartArea.selectAll("rect").on("click", function(event, d){
                    console.log(d);
                    updateDash(this, d);
                    currentSelectedYear = d;

                })

                function updateDash(This, d){
                    if (This!=undefined){
                        let selectedRect = d3.select(This);
                        //if year is already selected
                        if (selectedRect.attr("fill")=="#bab8b8"){
                            d3.select(This).attr("fill", "#e0e0e0");
                            lineBChart.attr("visibility", "hidden");
                        }
                        else{
                            lineChartArea.selectAll("rect").attr("fill", "#e0e0e0");
                            d3.select(This).attr("fill", "#bab8b8");
                            lineBChart.attr("visibility", "visible");
                        };
                    }
                    
                    if (d!=undefined){
                        lineBonusTitle.text("Income by Quintile for "+ d["Year"].toString());
                    }

                    //name mappings
                    var quintileMappings = {
                        "current_firstQuintile": "Q1",
                        "current_secondQuintile": "Q2",
                        "current_thirdQuintile": "Q3",
                        "current_fourthQuintile": "Q4",
                        "current_fifthQuintile": "Q5",
                        "adjusted_firstQuintile": "Q1",
                        "adjusted_secondQuintile": "Q2",
                        "adjusted_thirdQuintile": "Q3",
                        "adjusted_fourthQuintile": "Q4",
                        "adjusted_fifthQuintile": "Q5"
                    };

                    let quintiles = ["firstQuintile", "secondQuintile", "thirdQuintile", "fourthQuintile", "fifthQuintile"];

                    quintiles.forEach(q =>{
                        if (hasBeenClicked){
                            lineBChartArea.select("rect."+q)
                                        .transition().duration(500)
                                        .attr("x", line_qScale(quintileMappings[currentDollarType+"_"+q])+15)
                                        .attr("y", dollarBScale(d[currentDollarType+"_"+q]))
                                        .attr("height", lBchartHeight-dollarBScale(d[currentDollarType+"_"+q]));
                        }
                        else{
                            lineBChartArea.append("rect")
                                .attr("class", q)
                                .attr("x", line_qScale(quintileMappings[currentDollarType+"_"+q])+15)
                                .attr("y", dollarBScale(d[currentDollarType+"_"+q]))
                                .attr("width", 35)
                                .attr("height", m=> lBchartHeight-dollarBScale(d[currentDollarType+"_"+q]))
                                .attr("fill", "#bab8b8");
                        }

                    })

                    // add tuition line
                    if (d!=undefined){
                        selectedYearTuition = tuition.filter(t=> t.year == d.Year & t.institution_type == "all" & t.dollar_type == currentDollarType);

                        if (!tuitionLine){
                            lineBChartArea.append("line")
                                    .attr("x1", 0)
                                    .attr("x2", lBchartWidth)
                                    .attr("y1", t=> dollarBScale(selectedYearTuition[0].four_and_two_year))
                                    .attr("y2", t=> dollarBScale(selectedYearTuition[0].four_and_two_year))
                                    .attr("stroke", lineColorScale("all"))
                                    .attr("stroke-width", 3)
                                    .attr("id", "tuitionLine");
                        }
                        else{
                            d3.select("#tuitionLine")
                            .attr("y1", t=> dollarBScale(selectedYearTuition[0].four_and_two_year))
                            .attr("y2", t=> dollarBScale(selectedYearTuition[0].four_and_two_year));
                        }


                        hasBeenClicked = true;
                        tuitionLine = true;
                    }
                    


                    // adding hovering to bonus chart

                    lineBChartArea.selectAll("rect").on("mouseover", function(event){

                        let rectClass = d3.select(this).attr("class");
                        console.log(d);
                        d3.select(this).attr("stroke", "black")
                                    .attr("stroke-width", 2);
                        let barIncome = d[currentDollarType+"_"+rectClass];
                        let lineTuition = selectedYearTuition[0].four_and_two_year;
                        let f = d3.format(".2%")
                        let percentageOfIncome = f(lineTuition/barIncome);
                        percentLabel.text(percentageOfIncome.toString())
                                    .attr("x", line_qScale(quintileMappings[currentDollarType+"_"+rectClass])+13)
                                    .attr("y", dollarBScale(d[currentDollarType+"_"+rectClass])-5)
                                    .style("font-weight", "bold");



                    })

                    lineBChartArea.selectAll("rect").on("mouseout", function(event){

                        let rectClass = d3.select(this).attr("class");
                        d3.select(this).attr("stroke", "none");
                        percentLabel.text("");

                        })
                }

                // add additional tuition lines
                function addTuitionLine(year, type){

                }

                // ratio chart

                let ratioTitle = ratioChart.append("text")
                                                   .attr("x", 100)
                                                   .attr("y", 15)
                                                   .style("font-size", 20)
                                                   .style("font-weight", "bold")
                                                   .text("Tuition to Mean Income Ratio");

                let ratioScale = d3.scaleLinear().domain([0.10, 0.5]).range([ratiochartHeight, 0]);
                let ratioYearScale = d3.scaleLinear().domain([yearExtent[0]-0.5, yearExtent[1]+0.5]).range([0, ratiochartWidth]);

                let ratioLeftAxis = d3.axisLeft(ratioScale);
                ratioChart.append("g")
                          .attr("class", "left-axis")
                          .attr("transform", `translate(${ratio_margins.left-10}, ${ratio_margins.top})`)
                          .call(ratioLeftAxis);

                let ratioLeftAxisGridlines = d3.axisLeft(ratioScale)
                                               .tickFormat("")
                                               .tickSize(-ratiochartWidth-10);
                ratioChart.append("g")
                          .attr("class", "gridlines")
                          .attr("transform", `translate(${ratio_margins.left-10}, ${ratio_margins.top})`)
                          .call(ratioLeftAxisGridlines);

                let ratioBottomAxis = d3.axisBottom(ratioYearScale)
                                        .tickFormat(d3.format(".0f"));
                ratioChart.append("g")
                          .attr("class", "bottom-axis")
                          .attr("transform", `translate(${ratio_margins.left}, ${ratio_margins.top+ratiochartHeight+10})`)
                          .call(ratioBottomAxis);

                // collect ratios

                function updateRatio(){
                    deleteRatioLine();
                    let ratios = [];
                    let index = 0;
                    for (i=1968; i<2022; i++){
                        let selectedTuition = d3.filter(tuition, t=> t.year == i & t.institution_type == "all" & t.dollar_type == currentDollarType);
                        let selectedIncome = d3.filter(meanIncomes, m => m.Year == i);
                        let ratio = selectedTuition[0][currentDegreeLength]/selectedIncome[0][currentDollarType+"_thirdQuintile"];

                        ratios[index] = {year:i, ratio: ratio};
                        index++;
                    }

                    console.log(ratios);

                    let ratioLine = d3.line()
                                .x(d => ratioYearScale(d.year))
                                .y(d => ratioScale(d.ratio));

                    ratioChartArea.append("path").datum(ratios)
                                .attr("class", "ratioLine")
                                .attr("fill", "none")
                                .attr("stroke", lineColorScale("all"))
                                .attr("stroke-width", 3)
                                .attr("d", ratioLine);
                    ratioChartArea.raise();
                }

                function deleteRatioLine() {
                    var line = d3.select(".ratioLine")
                    if (line) {
                        line.remove();
                    } else {
                        console.log("Path element not found.");
                    }
                };

                updateRatio();






                // Ivy filters
                let IvyFilters = d3.select("#ivy_filters");
                let binInputs = IvyFilters.append("div").attr("id", "binInputs");

                let income_bins = {
                    "par_toppt1pc": "Top 0.1%",
                    "par_top1pc": "Top 1%",
                    "par_top5pc": "Top 5%",
                    "par_top10pc": "Top 10%",
                    "par_q5": "Top 20%",
                    "par_q4": "20-40th Percentile",
                    "par_q3": "40-60th Percentile",
                    "par_q2": "60-80th Percentile",
                    "par_q1": "Lowest 20%",

                };

                Object.entries(income_bins).forEach(([key, value]) => {
                    let block = binInputs.append("g");
                    let input = block.append("input")
                         .attr("type", "radio")
                         .attr("id", "check1" + key)
                         .attr("class", "income_radio")
                         .attr("value", key);
                    if (key === "par_q1") {
                        input.attr("checked", true);
                    }
                    block.append("label")
                         .attr("for", "check1" + key)
                         .text(value);
                });


                // ivy chart
                // stan original: #8C1515, chicago original: #800000
                let colorScale = d3.scaleOrdinal()
                    .domain(parentBins.map(s=>s.name))
                    .range(["#4E3629", "#9BCBEB", "#B31B1B", "#046A38", "#003087", "#A41034", "#750014", "#FF671F", "#da0d1c", "#670E10", "#011F5B", "#00356B", "gray"]);

                let iconUrlMap = {
                    "Brown": "brown.png",
                    "Columbia": "columbia.svg",
                    "Cornell": "cornell.png",
                    "Dartmouth": "dartmouth.png",
                    "Duke": "duke.png",
                    "Harvard": "harvard.png",
                    "MIT": "mit.png",
                    "Princeton": "princeton.png",
                    "Stanford": "stanford.png",
                    "Uchicago": "uchicago.png",
                    "Penn": "penn.png",
                    "Yale": "yale.png"
                };


                function updateChart(selectedOption) {
                    d3.select("#vis3_title").text("% of Students Belonging To The "+ income_bins[selectedOption] + " Across Top US Universities");

                    let schools = parentBins.map(s=>s.name);
                    console.log(schools);
                    let schoolScale = d3.scaleBand().domain(schools).range([0, ivyChartWidth]).padding(0.1);

                    let extent = d3.extent(parentBins, p => p[selectedOption]);
                    let percentScale = d3.scaleLinear().domain([0, extent[1]+0.01]).range([ivyChartHeight, 0]);

                    ivyChart.selectAll(".left-axis, .gridlines, .bottom-axis").remove();

                    let ivyLeftAxis = d3.axisLeft(percentScale)
                        .tickFormat(function(d) {
                            return selectedOption === "par_toppt1pc" ? d3.format(".1%")(d) : d3.format(".0%")(d);
                        });
                    ivyChart.append("g")
                                .attr("class", "left-axis")
                                .attr("transform", `translate(${ivy_margins.left-10}, ${ivy_margins.top})`)
                                .call(ivyLeftAxis);
                    let ivyLeftAxisGridlines = d3.axisLeft(percentScale)
                                                .tickSize(-ivyChartWidth-10)
                                                .tickFormat('');
                    ivyChart.append("g")
                                .attr("transform", `translate(${ivy_margins.left-10}, ${ivy_margins.top})`)
                                .attr("class", "gridlines")
                                .call(ivyLeftAxisGridlines);


                    let ivyBottomAxis = d3.axisBottom(schoolScale)
                                            .tickFormat(d => {
                                                            if (d === "National Avg") {
                                                                return d;
                                                            } else {
                                                                return "";
                                                            }
                                                        });

                    let bottomAxisGroup = ivyChart.append("g")
                                .attr("class", "bottom-axis")
                                .attr("transform", `translate(${ivy_margins.left}, ${ivy_margins.top+ivyChartHeight+10})`);

                    Object.keys(iconUrlMap).forEach((school, index) => {
                        if (school !== "National Avg") {
                            let iconWidth = 20;
                            let iconHeight = 20;
                            let y_pos = 10;
                            let x_pos = index * 56.5 + 22;

                            if (school === "Yale") {
                                iconWidth = 32;
                                iconHeight = 32;
                                y_pos = 3;
                                x_pos = x_pos-5;

                            }

                            if (school === "Stanford") {
                                iconWidth = 26;
                                iconHeight = 26;
                                y_pos = 6;
                                x_pos = x_pos-3;
                            }


                            bottomAxisGroup.append("image")
                                .attr("xlink:href", iconUrlMap[school])
                                .attr("width", iconWidth)
                                .attr("height", iconHeight)
                                .attr("x", x_pos)
                                .attr("y", y_pos);
                        }
                    });

                    bottomAxisGroup.call(ivyBottomAxis);

                    ivyChartArea.raise();

                    ivyChartArea.selectAll("rect").data(parentBins)
                                .join("rect")
                                .transition().duration(500)
                                .attr("class", "ivy_rect")
                                .attr("x", s => schoolScale(s.name) + 8)
                                .attr("y", p => percentScale(p[selectedOption]))
                                .attr("width", 35)
                                .attr("height", p => ivyChartHeight - percentScale(p[selectedOption]))
                                .attr("fill", s => colorScale(s.name));

                    //
                    let Label = ivyChartArea.append("text");

                    ivyChartArea.selectAll("rect").on("mouseover", function(event, d){
                        d3.select(this)
                          .attr("stroke", "black")
                          .attr("stroke-width", 2);

                          Label.text((d[selectedOption] * 100).toFixed(2) + "%")
                              .attr("x", schoolScale(d.name) + 6)
                              .attr("y", percentScale(d[selectedOption])-5)
                              .raise();
                    });

                    ivyChartArea.selectAll("rect").on("mouseout", function(event, d){
                        d3.select(this)
                          .attr("stroke", "white")
                          .attr("stroke-width", 0);

                          Label.text("");
                    });


                }

                updateChart("par_q1");

                d3.selectAll('input[type=radio][class=income_radio]').on('click', function() {

                    d3.selectAll('input[type=radio][class=income_radio]')
                        .filter(function() { return this !== event.target; })
                        .property('checked', false);

                    updateChart(this.value);
                });




                ivyChartArea.selectAll("rect")
                    .on("click", function(event, d) {

                        d3.select("#vis4")
                            .style("display", "flex");
                        d3.select("#vis4_title")
                            .style("display", "block");

                        //
                        d3.select(this)
                            .attr("fill-opacity", 1);

                        ivyChartArea.selectAll("rect")
                            .filter(bar => bar !== d)
                            .attr("fill-opacity", 0.6);


                // function updateBonusChart(schoolName) {
                //     const filteredData = parentBins.filter(d => d.name === schoolName);

                        d3.select("#vis4_title").text("Parental Income Distribution At " + d.name);

                        let qScale = d3.scaleBand().domain(['Q1', 'Q2', 'Q3', 'Q4', 'Q5']).range([0, ivyBChartWidth]).padding(0.1);
                        let maxPct = d3.max(parentBins, d => d3.max([d.par_q1, d.par_q2, d.par_q3, d.par_q4, d.par_q5]));

                        let percentBScale = d3.scaleLinear().domain([0, maxPct+0.05]).range([ivyBChartHeight, 0]);

                        ivyBChart.selectAll(".left-axis, .gridlines, .bottom-axis").remove();

                        let ivyBLeftAxis = d3.axisLeft(percentBScale)
                            .tickFormat(d3.format(".0%"));
                        ivyBChart.append("g")
                                    .attr("class", "left-axis")
                                    .attr("transform", `translate(${ivy_Bmargins.left-10}, ${ivy_Bmargins.top})`)
                                    .call(ivyBLeftAxis);
                        let ivyBLeftAxisGridlines = d3.axisLeft(percentBScale)
                                                    .tickSize(-ivyBChartWidth-10)
                                                    .tickFormat('');
                        ivyBChart.append("g")
                                    .attr("transform", `translate(${ivy_Bmargins.left-10}, ${ivy_Bmargins.top})`)
                                    .attr("class", "gridlines")
                                    .call(ivyBLeftAxisGridlines);

                        let ivyBBottomAxis = d3.axisBottom(qScale);
                        ivyBChart.append("g")
                                    .attr("class", "bottom-axis")
                                    .attr("transform", `translate(${ivy_Bmargins.left}, ${ivy_Bmargins.top+ivyBChartHeight+10})`)
                                    .call(ivyBBottomAxis);


                        //
                        let clickedSchool = d.name;
                        let filteredData = parentBins.filter(item => item.name === clickedSchool);


                        ivyBChartArea.selectAll("rect")
                            .data(filteredData.flatMap(d =>
                                ["par_q1", "par_q2", "par_q3", "par_q4", "par_q5"].map((key, index) => ({
                                    school: d.name,
                                    value: d[key],
                                    key: "Q" + (index + 1),
                                    original: key
                                }))
                            ))
                            .join("rect")
                            .transition().duration(500)
                            .attr("x", d => qScale(d.key) + 12)
                            .attr("y", d => percentBScale(d.value))
                            .attr("width", 35)
                            .attr("height", d => ivyBChartHeight - percentBScale(d.value))
                            .attr("fill", d => colorScale(d.school));

                        ivyBChartArea.raise();


                        function calculateRank(key, school) {
                            let newData = parentBins.filter(d => d.name !== "National Avg");
                            console.log(school);

                            let valuesForKey = newData.map(d => d[key]);

                            let sortedValues = valuesForKey.slice().sort((a, b) => a - b);
                            let schoolIndex = sortedValues.findIndex(value => value === newData.find(d => d.name === school)[key]);

                            let rank = sortedValues.length - schoolIndex;
                            return rank + "/" + sortedValues.length;
                        }

                        let BLabel = ivyBChartArea.append("text");
                        let QTooltip = d3.select("#q_popup");

                        ivyBChartArea.selectAll("rect").on("mouseover", function(event, d){
                            d3.select(this)
                                .attr("stroke", "black")
                                .attr("stroke-width", 2);

                             BLabel.text((d.value*100).toFixed(2)+"%")
                                .attr("x", qScale(d.key)+8)
                                .attr("y", percentBScale(d.value)-5)
                                .raise();

                            let rank = calculateRank(d.original, d.school);

                            QTooltip.text(d.school + " " + d.key + " rank: " + rank);
                            d3.select("#explanation").style("display", "block");
                        });

                        ivyBChartArea.selectAll("rect").on("mouseout", function(event, d){
                            d3.select(this)
                              .attr("stroke", "white")
                              .attr("stroke-width", 0);

                              BLabel.text("");

                              QTooltip.text("");
                              d3.select("#explanation").style("display", "none");
                        });

                });

                ivyChart.on("click", function(event, d) {
                    if (event.target == this) {
                        ivyChartArea.selectAll("rect")
                            .attr("fill-opacity", 1);

                        ivyBChart.selectAll("rect").remove();


                        d3.select("#vis4").style("display", "none");
                        d3.select("#vis4_title").style("display", "none");

                    }
                });

                // updateBonusChart('Cornell');
                //
                //
                // ivyChartArea.selectAll("rect")
                //     .on("click", function(event, d) {
                //         updateBonusChart(d.name);
                // });

            }

            requestData();

        </script>
    </body>
</html>
